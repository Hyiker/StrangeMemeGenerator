<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>生草黑白日文表情包生成器</title>
        <link rel="stylesheet" href="base.css" />
        <meta name="viewport" content="width=device-width,user-scalable=0" />
        <meta name="description" content="生草的黑白日文表情包生成器" />
    </head>
    <body>
        <header>
            <h1>生草黑白日文表情包生成器</h1>
            <div class="description">
                <span>奇怪的表情包增加了</span>
            </div>
        </header>
        <main>
            <canvas class="display" width="700" height="350"></canvas>
            <div class="input-wrapper">
                <input
                    type="text"
                    class="japanese text-raw"
                    placeholder="输入日文"
                />
                <input
                    type="text"
                    class="chinese text-raw"
                    placeholder="输入中文"
                />
            </div>
            <input
                id="file-selector"
                type="file"
                accept="image/png, image/jpeg, image/gif, image/jpg"
            />
        </main>
        <script src="https://cdn.bootcdn.net/ajax/libs/axios/0.19.2/axios.min.js"></script>
        <script src="https://cdn.bootcdn.net/ajax/libs/crypto-js/4.0.0/core.min.js"></script>
        <script src="https://cdn.bootcdn.net/ajax/libs/crypto-js/4.0.0/md5.min.js"></script>
        <script type="application/javascript">
            let display = document.querySelector(".display");
            let context = display.getContext("2d");
            let dpr = 1;
            let chinese = "";
            let japanese = "";
            let chinese_input = document.querySelector(".chinese");
            let japanese_input = document.querySelector(".japanese");
            let textAreaHeight = 80;
            let oldWidth = parseInt(window.innerWidth * 0.7);
            let oldHeight = display.height;
            let file_selector = document.getElementById("file-selector");
            makeHighRes(display);

            window.onload = onLoad;
            file_selector.onchange = function () {
                let files = file_selector.files;
                let reader = new FileReader();
                reader.readAsDataURL(files[0]);
                reader.onload = function (e) {
                    drawImage(this.result);
                };
            };
            display.onclick = function () {
                const event = new MouseEvent("click", {
                    view: window,
                    bubbles: true,
                    cancelable: true,
                });
                file_selector.dispatchEvent(event);
            };
            japanese_input.oninput = chinese_input.oninput = function () {
                japanese = japanese_input.value;
                chinese = chinese_input.value;
                context.fillStyle = "#000";
                context.fillRect(
                    0,
                    display.height / dpr - textAreaHeight,
                    display.width / dpr,
                    textAreaHeight
                );
                _drawText(
                    chinese,
                    display.width / 2,
                    display.height - textAreaHeight / 2,
                    textAreaHeight / dpr,
                    "#fff"
                );
                _drawText(
                    japanese,
                    display.width / 2,
                    display.height - textAreaHeight * 1.1,
                    textAreaHeight / dpr,
                    "#fff"
                );
            };

            function onLoad() {
                drawText("拖拽图片到此处或点击选择");
            }
            function makeHighRes(canvas) {
                let ctx = canvas.getContext("2d");
                // Get the device pixel ratio, falling back to 1.
                dpr =
                    window.devicePixelRatio ||
                    window.webkitDevicePixelRatio ||
                    window.mozDevicePixelRatio ||
                    1;
                // Give the canvas pixel dimensions of their CSS
                // size * the device pixel ratio.
                canvas.width = Math.round(oldWidth * dpr);
                canvas.height = Math.round(oldHeight * dpr);
                canvas.style.width = oldWidth + "px";
                canvas.style.height = oldHeight + "px";
                // Scale all drawing operations by the dpr, so you
                // don't have to worry about the difference.
                ctx.scale(dpr, dpr);
                return ctx;
            }
            function drawText(text) {
                context.clearRect(0, 0, display.width, display.height);
                context.font = "20px Microsoft YaHei";
                context.fillStyle = "#555";
                context.textAlign = "center";
                context.fillText(
                    text,
                    display.width / 2 / dpr,
                    display.height / 2 / dpr
                );
            }
            function _drawText(text, x, y, fontSize, fontColor) {
                context.font = fontSize / 2 + "px Microsoft YaHei";
                context.fillStyle = fontColor;
                context.textAlign = "center";
                context.fillText(text, x / dpr, y / dpr);
            }
            function drawImage(imageData) {
                let img = new Image();
                img.src = imageData;
                img.onload = function () {
                    let imgWidth = img.width,
                        imgHeight = img.height;
                    textAreaHeight = Math.min(Math.max(imgHeight / 3, 80), 120);
                    // alert(imgWidth + "," + imgHeight);
                    oldHeight =
                        Math.round(
                            imgHeight / (imgWidth / display.width) / dpr
                        ) + textAreaHeight;
                    makeHighRes(display);

                    context.drawImage(
                        img,
                        0,
                        0,
                        display.width / dpr,
                        display.height / dpr - textAreaHeight
                    );
                    let data = context.getImageData(
                        0,
                        0,
                        display.width,
                        display.height - textAreaHeight
                    );
                    for (let i = 0; i < data.data.length; i += 4) {
                        let grey =
                            data.data[i] * 0.3 +
                            data.data[i + 1] * 0.59 +
                            data.data[i + 2] * 0.11;
                        data.data[i] = data.data[i + 1] = data.data[
                            i + 2
                        ] = grey;
                    }
                    context.putImageData(data, 0, 0);
                    context.fillStyle = "#000";
                    context.fillRect(
                        0,
                        display.height / dpr - textAreaHeight,
                        display.width / dpr,
                        textAreaHeight
                    );
                };
            }
            display.addEventListener("dragover", function (e) {
                e.preventDefault();
                e.stopPropagation();
                drawText("释放鼠标");
            });
            display.addEventListener("dragleave", function (e) {
                e.preventDefault();
                e.stopPropagation();
                drawText("拖拽图片到此处或点击选择");
            });
            display.addEventListener("drop", function (e) {
                // 必须要禁用浏览器默认事件
                e.preventDefault();
                e.stopPropagation();
                let files = this.files || e.dataTransfer.files;
                let reader = new FileReader();
                reader.readAsDataURL(files[0]);
                reader.onload = function (e) {
                    drawImage(this.result);
                };
            });
        </script>
    </body>
</html>
